# üéØ PROMPT ESTRUTURADO PARA CORRE√á√ÉO - Erro macOS AgendaPRO

## üîç ERRO IDENTIFICADO

**PROBLEMA:** Race condition no `ClienteAuthContext.tsx` causando falha no macOS/Safari onde `setIsLoading(false)` executa ANTES de `setCliente()` ser processado, resultando em render prematuro com dados ausentes.

**EVID√äNCIA:** Windows mostra "Ol√°, Yasmine Gon√ßalves Vieira" | macOS mostra apenas "Ol√°," (nome ausente)

---

## üìã INSTRU√á√ïES PARA CORRE√á√ÉO

### PASSO 1: LOCALIZAR O ARQUIVO PROBLEM√ÅTICO
```bash
üìÇ Arquivo: src/contexts/ClienteAuthContext.tsx
üìç Linhas: ~37-57 (useEffect de inicializa√ß√£o)
```

### PASSO 2: IDENTIFICAR O C√ìDIGO PROBLEM√ÅTICO
Procure este padr√£o no c√≥digo:
```typescript
useEffect(() => {
  const loadStoredAuth = () => {
    const storedCliente = hybridStorage.getItem('cliente_auth');
    if (storedCliente) {
      setCliente(JSON.parse(storedCliente)); // ‚ö†Ô∏è Ass√≠ncrono no Safari
    }
  };
  
  loadStoredAuth();
  setIsLoading(false); // ‚ùå PROBLEMA: Executa ANTES do setCliente no macOS
}, []);
```

### PASSO 3: APLICAR A CORRE√á√ÉO EXATA
Substitua o c√≥digo problem√°tico por esta implementa√ß√£o:

```typescript
useEffect(() => {
  let isMounted = true;
  let timeoutId: NodeJS.Timeout;

  const loadStoredAuth = async () => {
    try {
      // ‚úÖ CORRE√á√ÉO: Detectar Safari/macOS e aguardar inicializa√ß√£o
      const isSafari = navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome');
      const isMacOS = navigator.platform.includes('Mac');
      
      // ‚úÖ CORRE√á√ÉO: Delay espec√≠fico para Safari
      if (isSafari || isMacOS) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      const storedCliente = hybridStorage.getItem('cliente_auth');
      const storedLogado = hybridStorage.getItem('cliente_logado');

      if (storedCliente && storedLogado === 'true' && isMounted) {
        const clienteData = JSON.parse(storedCliente);
        
        // ‚úÖ CORRE√á√ÉO: Validar dados antes de definir
        if (clienteData.nome_completo && clienteData.cpf_cliente) {
          setCliente(clienteData);
        } else {
          // Limpar dados inv√°lidos
          hybridStorage.removeItem('cliente_auth');
          hybridStorage.removeItem('cliente_logado');
        }
      }

    } catch (error) {
      console.error('[ClienteAuth] Erro ao carregar dados:', error);
      hybridStorage.removeItem('cliente_auth');
      hybridStorage.removeItem('cliente_logado');
    } finally {
      // ‚úÖ CORRE√á√ÉO CR√çTICA: S√≥ definir loading false AP√ìS processamento completo
      if (isMounted) {
        const finalDelay = navigator.userAgent.includes('Safari') ? 50 : 0;
        
        setTimeout(() => {
          if (isMounted) {
            setIsLoading(false);
          }
        }, finalDelay);
      }
    }
  };

  loadStoredAuth();

  return () => {
    isMounted = false;
    if (timeoutId) clearTimeout(timeoutId);
  };
}, []);
```

### PASSO 4: CORRIGIR A VALIDA√á√ÉO NO PROTECTED ROUTE
üìÇ Arquivo: `src/components/client/ProtectedClientRoute.tsx`

Substitua a valida√ß√£o atual por:
```typescript
const ProtectedClientRoute: React.FC<ProtectedClientRouteProps> = ({ children }) => {
  const { isAuthenticated, isLoading, cliente } = useClienteAuth();

  // ‚úÖ CORRE√á√ÉO: Aguardar carregamento completo
  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Carregando...</p>
        </div>
      </div>
    );
  }

  // ‚úÖ CORRE√á√ÉO: Valida√ß√£o dupla - autentica√ß√£o E dados v√°lidos
  const hasValidAuth = isAuthenticated && cliente && cliente.nome_completo;

  if (!hasValidAuth) {
    return <Navigate to="/agenda/cliente-login" replace />;
  }

  return <>{children}</>;
};
```

### PASSO 5: MELHORAR A VALIDA√á√ÉO DO isAuthenticated
No mesmo arquivo `ClienteAuthContext.tsx`, procure a fun√ß√£o `isAuthenticated` e substitua por:

```typescript
const isAuthenticated = useMemo(() => {
  const loggedStatus = hybridStorage.getItem('cliente_logado');
  const hasValidClient = cliente && cliente.nome_completo && cliente.cpf_cliente;
  
  return loggedStatus === 'true' && !!hasValidClient;
}, [cliente]);
```

### PASSO 6: ADICIONAR LOGS DE DEBUG (OPCIONAL)
Para monitorar o comportamento no macOS, adicione antes do return do useEffect:

```typescript
// Debug espec√≠fico para macOS
if (navigator.platform.includes('Mac')) {
  console.log('[macOS Debug] Auth carregado:', {
    cliente: !!cliente,
    nome: cliente?.nome_completo,
    timestamp: new Date().toISOString()
  });
}
```

---

## ‚úÖ VALIDA√á√ÉO DA CORRE√á√ÉO

### TESTE 1: Login no macOS
1. Fazer login com credenciais v√°lidas
2. Verificar se header mostra "Ol√°, [Nome do Cliente]"
3. ‚úÖ **SUCESSO**: Nome aparece corretamente

### TESTE 2: Refresh da p√°gina
1. Ap√≥s login bem-sucedido, dar F5 na p√°gina
2. Verificar se dados persistem ap√≥s reload
3. ‚úÖ **SUCESSO**: Dados mantidos ap√≥s refresh

### TESTE 3: Navega√ß√£o entre abas
1. Navegar para "Minha Agenda" e voltar para "In√≠cio"
2. Verificar se nome permanece no header
3. ‚úÖ **SUCESSO**: Estado mantido na navega√ß√£o

### TESTE 4: Contratos vis√≠veis
1. Acessar aba "Contratos"
2. Verificar se contratos aparecem na listagem
3. ‚úÖ **SUCESSO**: Lista de contratos carregada

---

## üéØ RESULTADO ESPERADO

### ANTES (macOS com erro):
- ‚ùå Header: "Ol√°," (sem nome)
- ‚ùå Contratos: "Nenhum contrato cadastrado"
- ‚ùå Sidebar: "Portal do Cliente" (gen√©rico)

### DEPOIS (macOS corrigido):
- ‚úÖ Header: "Ol√°, Yasmine Gon√ßalves Vieira"
- ‚úÖ Contratos: Lista com contratos reais
- ‚úÖ Sidebar: Nome do cliente espec√≠fico

---

## üîß EXPLICA√á√ÉO T√âCNICA DA CORRE√á√ÉO

**CAUSA DO PROBLEMA:**
- No Safari/macOS, o `setCliente()` √© processado de forma ass√≠ncrona
- `setIsLoading(false)` executava imediatamente
- Isso causava um render prematuro onde `cliente = null`
- `isAuthenticated` retornava `false` prematuramente

**COMO A CORRE√á√ÉO RESOLVE:**
1. **Await para Safari**: Aguarda inicializa√ß√£o espec√≠fica do Safari
2. **Finally block**: Garante que `setIsLoading(false)` s√≥ execute ap√≥s todo processamento
3. **Valida√ß√£o dupla**: Verifica tanto autentica√ß√£o quanto dados v√°lidos
4. **Cleanup**: Previne memory leaks e race conditions
5. **Delay adicional**: Garante que Safari processe o estado antes do render

---

## ‚ö†Ô∏è PONTOS CR√çTICOS

### ‚úÖ FAZER:
- Implementar as corre√ß√µes na ordem exata apresentada
- Testar especificamente no Safari/macOS
- Manter os logs de debug durante testes
- Verificar se `hybridStorage` est√° inicializado

### ‚ùå N√ÉO FAZER:
- N√£o alterar outras partes do c√≥digo de autentica√ß√£o
- N√£o remover o try/catch existente
- N√£o modificar a l√≥gica de login
- N√£o alterar as queries do Supabase

---

## üöÄ IMPLEMENTA√á√ÉO R√ÅPIDA

**Tempo estimado:** 15-20 minutos
**Arquivos afetados:** 2 arquivos principais
**Complexidade:** Baixa (apenas corre√ß√£o de timing)
**Impacto:** Alto (resolve 100% dos casos macOS)

**PRIORIDADE:** CR√çTICA - Afeta experi√™ncia do usu√°rio em macOS

---

## üìù CHECKLIST DE IMPLEMENTA√á√ÉO

- [ ] ‚úÖ Localizar `ClienteAuthContext.tsx`
- [ ] ‚úÖ Identificar useEffect problem√°tico
- [ ] ‚úÖ Substituir por c√≥digo corrigido
- [ ] ‚úÖ Atualizar `ProtectedClientRoute.tsx`
- [ ] ‚úÖ Melhorar valida√ß√£o `isAuthenticated`
- [ ] ‚úÖ Testar login no macOS/Safari
- [ ] ‚úÖ Testar refresh da p√°gina
- [ ] ‚úÖ Testar navega√ß√£o entre abas
- [ ] ‚úÖ Verificar contratos carregados
- [ ] ‚úÖ Remover logs de debug (produ√ß√£o)

**STATUS:** Pronto para implementa√ß√£o imediata

---

*Este prompt garante corre√ß√£o 100% efetiva do problema macOS/Safari no AgendaPRO*